<?php

class SBWModelFormatter {

  protected $model;


  public function SBWModelFormatter($model) {
    if ( !isset($model) ) {
      trigger_error("No model specified", E_USER_ERROR);
    }
    $this->model = $model;
  }


  public function formatModel() {
    $wikitext = '';
    $wikitext .= <<<WIKI
{{Category physicochemical model}}
{{Categoryhelper table end}}


<!-- the following text was auto-generated by the model importer -->

== Model Contents ==

'''Species:'''
{{#ask: [[is model species of::{{PAGENAME}}]]
| limit=15
}}

'''Reactions:'''
{{#ask: [[is model interaction of::{{PAGENAME}}]]
| limit=15
}}

WIKI;

    foreach ($this->model->getSpeciesIds() as $id) {
      $species = $this->model->getSpecies($id);
      $uid = $species->uid;
      $wikitext .= "[[has model species::$uid| ]]\n";
    }

    foreach ($this->model->getReactionIds() as $id) {
      $reaction = $this->model->getReaction($id);
      $uid = $reaction->uid;
      $wikitext .= "[[has model interaction::$uid| ]]\n";
    }

    return $wikitext;
  }


  public function formatSpecies($id) {
    $wikitext = '';

    $species = $this->model->getSpecies($id);
    $model_uid     = $this->model->uid;
    $name          = $species->name;
    $initial_value = $species->initialConcentration;
    $wikitext .= <<<WIKI
{{Category physicochemical species}}
{{Property full name|full_name=$name}}
{{Property initial value|initial_value=$initial_value}}
{{Categoryhelper table end}}


<!-- the following text was auto-generated by the model importer -->
[[is model species of::$model_uid| ]]
WIKI;

    return $wikitext;
  }


  public function formatReaction($id) {
    $wikitext = '';

    $reaction = $this->model->getReaction($id);
    $parameter_names  = array_keys($reaction->getParameters());
    $parameter_values = array_values($reaction->getParameters());

    $model_uid   = $this->model->uid;
    $name        = $reaction->name;
    $mass_action = $reaction->asText();
    $parameters  = implode(
                           "\n\n", 
                           array_map(create_function('$n,$v', 'return "$n = $v";'),
                                     $parameter_names, $parameter_values)
                           );

    $wikitext .= <<<WIKI
{{Category physicochemical reaction}} 
{{Property full name|full_name=$name}}
{{Categoryhelper table end}}


<!-- the following text was auto-generated by the model importer -->
[[is model interaction of::$model_uid| ]]
WIKI;

    return $wikitext;
  }


  public function formatAll() {
    $wikitext = '';

    $uid = $this->model->uid;
    $wikitext .= "<div style='border: 1px dashed #000000; background: #fcf8ff; padding: .5em;'>\n";
    $wikitext .= "= $uid =\n";
    $wikitext .= $this->formatModel();
    $wikitext .= "</div>\n\n\n";
    
    foreach ( $this->model->getSpeciesIds() as $id ) {
      $uid = $this->model->getSpecies($id)->uid;
      $wikitext .= "<div style='border: 1px dashed #000000; background: #f8fff8; padding: .5em;'>\n";
      $wikitext .= "= $uid =\n";
      $wikitext .= $this->formatSpecies($id);
      $wikitext .= "</div>\n\n\n";
    }

    foreach ( $this->model->getReactionIds() as $id ) {
      $uid = $this->model->getReaction($id)->uid;
      $wikitext .= "<div style='border: 1px dashed #000000; background: #fff8f8; padding: .5em;'>\n";
      $wikitext .= "= $uid =\n";
      $wikitext .= $this->formatReaction($id);
      $wikitext .= "</div>\n\n\n";
    }

    $wikitext .= "__NOTOC__\n";

    return $wikitext;
  }

}

?>
